---
title: "Import_QC_SRP073808"
output: html_document
---
todo: Size factors are negative, improve number of sizes in estimation.

Script and code follows "A step-by-step workflow for low-level analysis of single-cell RNA-seq data with Bioconductor". Aaron T. L. Lun1, Davis J. McCarthy2 and John C. Marioni. and the 

# Load and process data set: Koh 2016 SRP073808
```{r load libraries, include=FALSE}
# load packages
pdf("results/QC_data/QC_plots_koh2016.pdf")

suppressPackageStartupMessages(library(MultiAssayExperiment))
suppressPackageStartupMessages(library(scater))
suppressPackageStartupMessages(library(dplyr))
suppressPackageStartupMessages(library(tidyr))
suppressPackageStartupMessages(library(plyr))
suppressPackageStartupMessages(library(scran))
suppressPackageStartupMessages(library(cowplot))


```

## load multiassay dataset from IMLS conquer

```{r load dataset}
# load multiassay dataset from IMLS conquer
maex <- readRDS("data/SRP073808.rds")
# summary of data set

print(maex)
dim(assay(maex)) #  65218  x 651


# extract the gene-level TPM and the counts obtaines by scaling the TPMs
cts <- assays(experiments(maex)[["gene"]])[["count_lstpm"]]
tpms <- assays(experiments(maex)[["gene"]])[["TPM"]]

```
# extract the Phenotype data
There are three different subpopulations: knockout mouse and v6.5 mouse treated with serum or 2i.
```{r phentotypes, echo=TRUE}
# extract the phenotype data
phn <- colData(maex)

# extract the cell annotation to phenoid column and rename it 
phn[, "phenoid"] <- as.character(phn[,"LibraryName"])
table(phn[, "phenoid"])
```


```{r have a closer look to pheno, echo=TRUE}
phn.tbl <- as_data_frame(phn)
glimpse(phn.tbl)
```


# create an SCEset
The expr slot is populated with the count data; obtained from the length-scalaed , count-scaled tpms. The values are automatically log2 transformed. gene-level tpms for the tpm slot.

```{r create SCEset, echo=TRUE }
# Create an SCEobject 
sceset <- SingleCellExperiment(assays = list(counts = cts), colData = phn)
```

throw away features which are not expressed
```{r reduce expression matrix, throwing away features that are not expressed. noninformative features}
keep_features <- rowSums(counts(sceset) > 0) >= 1
table(keep_features)
sceset<- sceset[keep_features, ]
dim(sceset)
```

Populate logcounts slot
```{r log transform, echo=TRUE  }
logcounts(sceset) <- log2(calculateCPM(sceset,use.size.factors = FALSE) + 1)
```
# save raw sceset
```{r save raw data}
save(sceset,file = "data/sceset_raw_SRP073808.rda")

```


# Identify the ERCCC spike-ins.
There are 92 ERCCC spike-inn genes. No mitochondrial genes , probably they are not annotated yet.
```{r ERCC and mt genes }
is.spike <- grepl("^ERCC", rownames(sceset))
is.mito <- grepl("^mt-", rownames(sceset))
print( table(is.spike) )
print( table(is.mito) )

table(grepl("^ERCC", rownames(sceset))) 

```
# reduce expression set
Keep only those features that are observed in at least 1 cell. 16232 features out of 65 k are filtered out. The original counts are used. Using this setting all but five ERCC spike inns are filtered out

```{r reduce}
keep_features <- rowSums(counts(sceset) > 0) >= 1
table(keep_features)
sceset <- sceset[keep_features, ]
table(grepl("^ERCC", rownames(sceset))) 

```


# Compute some QC metrics
The ERCC is not set as a control feature. 3 cells were debris. Others cells were not well seperated, two ore more cells in a well.

```{r QC}
sceset <- calculateQCMetrics(sceset)
colnames(colData(sceset))

```

# Quality control on cells
Some cells have small library sizes (< 1 mio total counts) and show almost no expression. Candidates for filtering out.
```{r  histogramms }

size.med <- median(log10(sceset$total_counts), na.rm = TRUE)
size.mad <- mad(log10(sceset$total_counts), center = size.med, na.rm = TRUE)
lower.limit.size <- 10^(size.med - 3 * size.mad)
    
feature.med <- median(log10(sceset$total_features), na.rm = TRUE)
feature.mad <- mad(log10(sceset$total_features), center =feature.med, na.rm = TRUE)
lower.limit.feat <- 10^(feature.med - 3 * feature.mad  )


df.hist <- as.data.frame(cbind("total_counts"=sceset$total_counts,"total_features"=sceset$total_features) )

hist.1 <- ggplot(df.hist, aes(x=total_counts))+
  geom_histogram()+
  labs(x="Library sizes ",y="Number of cells" )+
  geom_vline(xintercept=lower.limit.size, color=2)

hist.2 <- ggplot(df.hist, aes(x=total_features))+
  geom_histogram()+
  labs(x="Number of expressed genes",y="Number of cells" )+
  geom_vline(xintercept=lower.limit.feat, color=2)

```
# Quality control using PCA and highest expressed genes
PCA plot based the quality metrics for each cell, e.g., the total number of reads, the total number of features and the proportion of mitochondrial or spike-in reads. 
```{r  Quality control using PCA }
p1 <- scater::plotPCA(sceset, exprs_values="logcounts", selected_variables="pdata",colour_by="phenoid")
p2 <- scater::plotQC(sceset, type = "find-pcs", variable = "total_features")


```

# Filter dataset gene wise and by librarysize 
Remove cells with log-library sizes that are more than 3 median absolute deviations (MADs) below the median log-library size. 52 cells were dropped according to this criteria, regarding the untransformed count data. add plot with threshold...
More than 10 % of the cells are removed, possibly there's a quality problem regarding the sequencing....
```{r save unfiltered data }
libsize.drop <- isOutlier(sceset$total_counts, nmads=3, type="lower", log=TRUE)

feature.drop <- isOutlier(sceset$total_features, nmads=3, type="lower", log=TRUE)
table(libsize.drop,feature.drop)

```
# Filter dataset by ERCCC spike inns
The amount of endogenous features should be constant. Cells with a high proportion should be removed.Most cells have no spike-inns, we dont use this filter. 

```{r  filter by spike inn }
#hist(sceset$pct_counts_feature_controls_ERCC, xlab="ERCC proportion (%)", 
#    ylab="Number of cells", breaks=20, main="", col="grey80")
    
```

Total 120  cells were filtered out. For the the subsequent analysis these were filtered out as well. After filtering t 531 cells are remaing. Filter is maybe too strict. The cells with low Lib sizes and total expressed features could be true subpopulations.


```{r overview filtered cells }
sceset.red <- sceset[,!(libsize.drop | feature.drop)]

data.frame(ByLibSize=sum(libsize.drop), ByFeature=sum(feature.drop)
    , Remaining=ncol(sceset.red))

```

# Quality control using PCA and highest expressed genes
PCA plot based the quality metrics for each cell, e.g., the total number of reads, the total number of features. Where as in the unreduced set we have two distinct groups (totalcounts < 1 M. and > 1 M ),this is not the case in the reduced set. The difference is possibly driven by the library size and the seqencuing depth. 
```{r  Quality control using PCA }
plotPCA(sceset, pca_data_input="pdata", colour_by= "phenoid")
plotPCA(sceset.red, pca_data_input="pdata", colour_by= "phenoid")
plotPCA(sceset, pca_data_input="pdata", size_by= "total_counts")
plotPCA(sceset.red, pca_data_input="pdata", size_by= "total_counts")
```


Plotting the 50 highest expressed genes. No ERCC spike-inn in the top 50. The profile should look relatively "flat".
```{r  highest expressed genes}
p3 <- plotQC(sceset.red, type = "highest-expression", n=50)

```

```{r mean freq expression}
plotQC(sceset.red, type = "exprs-freq-vs-mean")
```
# Filtering the datasets based on the features. Here genes with low abundance are filtered out. We have to sets of features one is based on the mean expression and one on a expression in minium n cells.
```{r  Filtering out low-abundance genes }
ave.counts <- rowMeans(counts(sceset.red))
keep <- ave.counts >= 1
sum(keep)
ave.counts<- as.data.frame(log10(ave.counts))

p4 <- ggplot(ave.counts, aes(ave.counts))+geom_histogram(binwidth = 0.5)+geom_vline(aes(xintercept=log10(1), color=1))+guides(color = "none")+labs( x = expression(Log[10]~"average count"), y = "frequency")

sceset.red <- sceset.red[keep, ]
dim(sceset.red)
```

Normalize data according to Lun etal. 2016 using pooled counts to estimate size factors. The size factors in the non-filterd set contain non positive values what does this mean?
The size factor is correlated with the library sizes. As we have a homogenous cell population there's no obvious grouping. The difference of library size between cells is possibly due the seqeuncing depth.

```{r normalize through pool-based size factors }
sceset <- computeSumFactors(sceset, sizes=c(20, 40, 80, 150))
summary(sizeFactors(sceset))

sceset.red <- computeSumFactors(sceset.red, sizes=c(20, 40, 80, 150))
summary(sizeFactors(sceset.red))

plot(sizeFactors(sceset), sceset$total_counts/1e6, log="xy",
    ylab="Library size (millions)", xlab="Size factor")
plot(sizeFactors(sceset.red), sceset.red$total_counts/1e6, log="xy",
    ylab="Library size (millions)", xlab="Size factor")
```



Use size factors to normalize gene expression. No spike inn counts in datasets 
```{r spike inn}

```
The counts are normalized using log2 transformation and applying the size factors for normalized gene expression. Are really the size factors from Lun et al. used or the ones from edgeR?
```{r normalization }

sceset <- normaliseExprs(sceset)

sceset.red <- normaliseExprs(sceset.red)

```


# Save the normalized and cell filtered datasets
```{r save data }
res <- sceset
dim(res)
save(res,file = "data/sceset_org_SRP073808.rda")

res <- sceset.red
dim(res)
save(res,file = "data/sceset_red_SRP073808.rda")



```


# Identifying HVGs from the normalized log-expression

```{r High variable genes }
var.fit <- trendVar(sceset.red, trend="loess", use.spikes=FALSE, span=0.2) 
var.out <- decomposeVar(sceset.red, var.fit)


```


```{r High variable genes using the variance of the log-expression }

plot(var.out$mean, var.out$total, pch=16, cex=0.6, xlab="Mean log-expression",
    ylab="Variance of log-expression")
o <- order(var.out$mean)
lines(var.out$mean[o], var.out$tech[o], col="dodgerblue", lwd=2)



hvg.out <- var.out[which(var.out$FDR <= 0.05 & var.out$bio >= 0.5),]
hvg.out <- hvg.out[order(hvg.out$bio, decreasing=TRUE),]
nrow(hvg.out)
head(hvg.out)
plotExpression(sceset.red, rownames(hvg.out)[1:10])

```
# Select only the 3704 high variable genes and save the SCEset.
```{r}

sceset.hvg <-sceset.red[ rownames(hvg.out), ]
dim(sceset.hvg)

res <- sceset.hvg
save(res,file = "data/sceset_hvg_SRP073808.rda")

```

# Plot summary
Plot the proportion of explained variances
```{r explained variance} 
expl_vars <- c( "phenoid","log10_total_counts", "log10_total_features", "pct_dropout",
               "pct_counts_top_200_features", "log10_counts_feature_controls",
               "pct_counts_feature_controls")
p5 <- plotQC(sceset.red, type = "explanatory-variables", variables = NULL)
```
plot tSNE represenatation
```{r tSNE}
p6 <- plotTSNE(sceset.red, exprs_values="logcounts", perplexity=5, colour_by="total_features",size_by="total_counts",return_SCESet=FALSE) + ggtitle("tSNE plot")

```
Plot a summary of the QC
```{r create QC plots} 


plot.qc <- plot_grid(hist.1,hist.2,p3,p4,p5,p6, ncol = 2, labels="auto")

save_plot("results/QC_data/qc_summary_koh.png", plot.qc,
          ncol = 2, # we're saving a grid plot of 2 columns
          nrow = 2 # and 2 rows
          )



```


Plot some tSNE plots showing the realtionsship between clusters and lib sizes
```{r plot tSNE} 
set.seed(1234)
out5 <- plotTSNE(sceset.red, exprs_values="exprs", perplexity=5, colour_by="total_features") + ggtitle("Perplexity = 5")
out10 <- plotTSNE(sceset.red, exprs_values="exprs", perplexity=10, colour_by="total_features") + ggtitle("Perplexity = 10")
out20 <- plotTSNE(sceset.red, exprs_values="exprs", perplexity=20, colour_by="total_features") + ggtitle("Perplexity = 20") 
multiplot(out5, out10, out20, cols=3)
ggsave("results/QC_data/tsnelibsize_koh2016.pdf")
dev.off()
```




# Appendix
```{r remove  batch effects  , eval=FALSE}

require(limma)

adj.exprs <- exprs(sceset.red)

adj.exprs <- removeBatchEffect(adj.exprs, batch=sceset.red$total_features )

norm_exprs(sceset.red) <- adj.exprs


plotTSNE(sceset.red, exprs_values="norm_exprs", perplexity=20, colour_by="phenoid",return_SCESet=FALSE) + ggtitle("adjusted for total features") 
plotTSNE(sceset.red, exprs_values="exprs", perplexity=20, colour_by="phenoid",return_SCESet=FALSE) + ggtitle("non adjusted") 


```
