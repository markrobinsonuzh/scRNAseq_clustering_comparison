---
title: "Import_QC_SRP073808"
output: html_document
---

Script and code follows "A step-by-step workflow for low-level analysis of single-cell RNA-seq data with Bioconductor". Aaron T. L. Lun1, Davis J. McCarthy2 and John C. Marioni. and the 

# Load and process data set: Koh 2016 SRP073808
```{r load libraries, include=FALSE}
# load packages

suppressPackageStartupMessages(library(MultiAssayExperiment))
suppressPackageStartupMessages(library(scater))
suppressPackageStartupMessages(library(dplyr))
suppressPackageStartupMessages(library(tidyr))
suppressPackageStartupMessages(library(plyr))
suppressPackageStartupMessages(library(scran))

```

## load multiassay dataset from IMLS conquer

```{r load dataset}
# load multiassay dataset from IMLS conquer
maex <- readRDS("data/SRP073808.rds")
# summary of data set

print(maex)
dim(assay(maex)) #  65218  x 651


# extract the gene-level TPM and the counts obtaines by scaling the TPMs
cts <- assays(experiments(maex)[["gene"]])[["count_lstpm"]]
tpms <- assays(experiments(maex)[["gene"]])[["TPM"]]

```
# extract the Phenotype data
There are three different subpopulations: knockout mouse and v6.5 mouse treated with serum or 2i.
```{r phentotypes, echo=TRUE}
# extract the phenotype data

phn <- colData(maex)

# extract the cell annotation to phenoid column and rename it 


phn[, "phenoid"] <- as.character(phn[,"LibraryName"])


table(phn[, "phenoid"])


```
# create an SCEset
The expr slot is populated with the count data; obtained from the length-scalaed , count-scaled tpms. The values are automatically log2 transformed. gene-level tpms for the tpm slot.

```{r create SCEset, echo=TRUE }
# Create an SCEobject 
sceset <- newSCESet(countData = cts, 
                    phenoData = new("AnnotatedDataFrame", data = as.data.frame(phn)))
exprs(sceset)[1:3,1:3]

set_exprs(sceset, "tpm") <- tpms # tpm is populated with the gene level tpms

get_exprs(sceset, "tpm")[1:3,1:3] # untransformed tpm
get_exprs(sceset, "counts")[1:3,1:3] # untransformed counts
exprs(sceset)[1:3,1:3] # log2 transformed counts

```
# Identify the ERCCC spike-ins.
There are 92 ERCCC spike-inn genes. No mitochondrial genes , probably they are not annotated yet.
```{r ERCC and mt genes }
is.spike <- grepl("^ERCC", rownames(sceset))
is.mito <- grepl("^mt-", rownames(sceset))
print( table(is.spike) )
print( table(is.mito) )

table(grepl("^ERCC", rownames(sceset))) 

```
# reduce expression set
Keep only those features that are observed in at least 1 cell. 16232 features out of 65 k are filtered out. The original counts are used. Using this setting all but five ERCC spike inns are filtered out

```{r reduce}
keep_features <- rowSums(counts(sceset) > 0) >= 1
table(keep_features)
sceset <- sceset[keep_features, ]

```


# Compute some QC metrics
The ERCC is not set as a control feature. 3 cells were debris. Others cells were not well seperated, two ore more cells in a well.

```{r QC}
sceset <- calculateQCMetrics(sceset )
colnames(pData(sceset))


```

# Quality control on cells
Some cells have small library sizes (< 1 mio total counts) and show almost no expression. Candidates for filtering out.
```{r  histogramms }
par(mfrow=c(2,2))
hist(sceset$total_counts/1e6, xlab="Library sizes ", main="", 
    breaks=20, col="grey80", ylab="Number of cells")
hist(sceset$total_features, xlab="Number of expressed genes", main="", 
    breaks=20, col="grey80", ylab="Number of cells")


```


# Filter dataset gene wise and by librarysize 
Remove cells with log-library sizes that are more than 3 median absolute deviations (MADs) below the median log-library size. 52 cells were dropped according to this criteria, regarding the untransformed count data. add plot with threshold...
More than 10 % of the cells are removed, possibly there's a quality problem regarding the sequencing....
```{r save unfiltered data }

libsize.drop <- isOutlier(sceset$total_counts, nmads=3, type="lower", log=TRUE)
feature.drop <- isOutlier(sceset$total_features, nmads=3, type="lower", log=TRUE)
table(libsize.drop,feature.drop)

```
# Filter dataset by ERCCC spike inns
The amount of endogenous features should be constant. Cells with a high proportion should be removed. however as almost all cells have no spike-inns we dont use this filter. 
```{r  filter by spike inn }

```

Total 120  cells were filtered out. For the the subsequent analysis these were filtered out as well. After filtering t 531 cells are remaing. Filter is maybe too strict. The cells with low Lib sizes and total expressed features could be true subpopulations.


```{r overview filtered cells }
sceset.red <- sceset[,!(libsize.drop | feature.drop)]

data.frame(ByLibSize=sum(libsize.drop), ByFeature=sum(feature.drop)
    , Remaining=ncol(sceset.red))

```

# Quality control using PCA and highest expressed genes
PCA plot based the quality metrics for each cell, e.g., the total number of reads, the total number of features. Where as in the unreduced set we have two distinct groups (totalcounts < 1 M. and > 1 M ),this is not the case in the reduced set. The difference is possibly driven by the library size and the seqencuing depth. 
```{r  Quality control using PCA }
p1 <- plotPCA(sceset, pca_data_input="pdata", colour_by= "phenoid")
p2 <- plotPCA(sceset.red, pca_data_input="pdata", colour_by= "phenoid")
p3 <- plotPCA(sceset, pca_data_input="pdata", size_by= "total_counts")
p4 <- plotPCA(sceset.red, pca_data_input="pdata", size_by= "total_counts")
multiplot(p1,p2,p3,p4, cols=2)
```


Plotting the 50 highest expressed genes. The profile should look relatively "flat".
```{r  highest expressed genes}
plotQC(sceset.red, type = "highest-expression", n=50)

```


Normalize data according to Lun etal. 2016 using pooled counts to estimate size factors. The size factors in the non-filterd set contain non positive values what does this mean?
The size factor is correlated with the library sizes. As we have a homogenous cell population there's no obvious grouping. The difference of library size between cells is possibly due the seqeuncing depth.

```{r normalize through pool-based size factors }
sceset <- computeSumFactors(sceset, sizes=c(20, 40, 80, 150))
summary(sizeFactors(sceset))

sceset.red <- computeSumFactors(sceset.red, sizes=c(20, 40, 80, 150))
summary(sizeFactors(sceset.red))

plot(sizeFactors(sceset), sceset$total_counts/1e6, log="xy",
    ylab="Library size (millions)", xlab="Size factor")
plot(sizeFactors(sceset.red), sceset.red$total_counts/1e6, log="xy",
    ylab="Library size (millions)", xlab="Size factor")
```

The counts are normalized using log2 transformation and applying the size factors for normalized gene expression. Are really the size factors from Lun et al. used or the ones from edgeR?
```{r normalization }
sceset <- normaliseExprs(sceset)

sceset.red <- normaliseExprs(sceset.red)

```

# Save the normalized and cell filtered datasets
```{r save data }
res <- sceset
save(res,file = "data/sceset_org_SRP073808.rda")

res <- sceset.red
save(res,file = "data/sceset_red_SRP073808.rda")

```


# Identifying HVGs from the normalized log-expression

```{r High variable genes }

var.fit <- trendVar(sceset.red, trend="loess", use.spikes=FALSE, span=0.2) 
var.out <- decomposeVar(sceset.red, var.fit)


```


```{r High variable genes using the variance of the log-expression }

plot(var.out$mean, var.out$total, pch=16, cex=0.6, xlab="Mean log-expression",
    ylab="Variance of log-expression")
o <- order(var.out$mean)
lines(var.out$mean[o], var.out$tech[o], col="dodgerblue", lwd=2)



hvg.out <- var.out[which(var.out$FDR <= 0.05 & var.out$bio >= 0.5),]
hvg.out <- hvg.out[order(hvg.out$bio, decreasing=TRUE),]
nrow(hvg.out)
head(hvg.out)
plotExpression(sceset.red, rownames(hvg.out)[1:10])

```
# Select only the 3704 high variable genes and save the SCEset.
```{r}

sceset.hvg <-sceset.red[ rownames(hvg.out), ]
dim(sceset.hvg)

res <- sceset.hvg
save(res,file = "data/sceset_hvg_SRP073808.rda")

```
Plot some tSNE plots showing the realtionsship between clusters and lib sizes
```{r plot tSNE} 
set.seed(1234)
out5 <- plotTSNE(sceset.red, exprs_values="exprs", perplexity=5, colour_by="total_features") + ggtitle("Perplexity = 5")
out10 <- plotTSNE(sceset.red, exprs_values="exprs", perplexity=10, colour_by="total_features") + ggtitle("Perplexity = 10")
out20 <- plotTSNE(sceset.red, exprs_values="exprs", perplexity=20, colour_by="total_features") + ggtitle("Perplexity = 20") 
multiplot(out5, out10, out20, cols=3)
```

